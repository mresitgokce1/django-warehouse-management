{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}
{% if object %}
{% trans "Ürün Düzenle" %}: {{ object.name }}
{% else %}
{% trans "Yeni Ürün" %}
{% endif %} - {{ block.super }}
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">{% trans "Panel" %}</a></li>
        <li class="breadcrumb-item"><a href="{% url 'products:list' %}">{% trans "Ürünler" %}</a></li>
        {% if object %}
        <li class="breadcrumb-item"><a href="{% url 'products:detail' object.slug %}">{{ object.name }}</a></li>
        <li class="breadcrumb-item active">{% trans "Düzenle" %}</li>
        {% else %}
        <li class="breadcrumb-item active">{% trans "Yeni Ürün" %}</li>
        {% endif %}
    </ol>
</nav>
{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">
            <i class="bi bi-box"></i> 
            {% if object %}
                {% trans "Ürün Düzenle" %}
            {% else %}
                {% trans "Yeni Ürün Ekle" %}
            {% endif %}
        </h1>
        {% if object %}
        <p class="text-muted mb-0">{{ object.name }}</p>
        {% endif %}
    </div>
    
    <div>
        {% if object %}
        <a href="{% url 'products:detail' object.slug %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> {% trans "Geri" %}
        </a>
        {% else %}
        <a href="{% url 'products:list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> {% trans "Ürün Listesi" %}
        </a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- Basic Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle"></i> {% trans "Temel Bilgiler" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="{{ form.name.id_for_label }}" class="form-label">
                                    {{ form.name.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                <div class="text-danger small mt-1">{{ form.name.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.category.id_for_label }}" class="form-label">
                                    {{ form.category.label }}
                                </label>
                                {{ form.category }}
                                {% if form.category.errors %}
                                <div class="text-danger small mt-1">{{ form.category.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.sku.id_for_label }}" class="form-label">
                                    {{ form.sku.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.sku }}
                                {% if form.sku.errors %}
                                <div class="text-danger small mt-1">{{ form.sku.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">{% trans "Benzersiz stok kodu" %}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.barcode.id_for_label }}" class="form-label">
                                    {{ form.barcode.label }}
                                </label>
                                {{ form.barcode }}
                                {% if form.barcode.errors %}
                                <div class="text-danger small mt-1">{{ form.barcode.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">{% trans "Opsiyonel barkod numarası" %}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.short_description.id_for_label }}" class="form-label">
                            {{ form.short_description.label }}
                        </label>
                        {{ form.short_description }}
                        {% if form.short_description.errors %}
                        <div class="text-danger small mt-1">{{ form.short_description.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            {{ form.description.label }}
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="text-danger small mt-1">{{ form.description.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Pricing Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-currency-exchange"></i> {% trans "Fiyat Bilgileri" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.cost_price.id_for_label }}" class="form-label">
                                    {{ form.cost_price.label }}
                                </label>
                                <div class="input-group">
                                    {{ form.cost_price }}
                                    <span class="input-group-text">₺</span>
                                </div>
                                {% if form.cost_price.errors %}
                                <div class="text-danger small mt-1">{{ form.cost_price.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.selling_price.id_for_label }}" class="form-label">
                                    {{ form.selling_price.label }} <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    {{ form.selling_price }}
                                    <span class="input-group-text">₺</span>
                                </div>
                                {% if form.selling_price.errors %}
                                <div class="text-danger small mt-1">{{ form.selling_price.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Stock Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-box-seam"></i> {% trans "Stok Bilgileri" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.stock_quantity.id_for_label }}" class="form-label">
                                    {{ form.stock_quantity.label }}
                                </label>
                                {{ form.stock_quantity }}
                                {% if form.stock_quantity.errors %}
                                <div class="text-danger small mt-1">{{ form.stock_quantity.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.min_stock_level.id_for_label }}" class="form-label">
                                    {{ form.min_stock_level.label }}
                                </label>
                                {{ form.min_stock_level }}
                                {% if form.min_stock_level.errors %}
                                <div class="text-danger small mt-1">{{ form.min_stock_level.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.max_stock_level.id_for_label }}" class="form-label">
                                    {{ form.max_stock_level.label }}
                                </label>
                                {{ form.max_stock_level }}
                                {% if form.max_stock_level.errors %}
                                <div class="text-danger small mt-1">{{ form.max_stock_level.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Physical Properties -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-rulers"></i> {% trans "Fiziksel Özellikler" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="{{ form.weight.id_for_label }}" class="form-label">
                                    {{ form.weight.label }}
                                </label>
                                <div class="input-group">
                                    {{ form.weight }}
                                    <span class="input-group-text">kg</span>
                                </div>
                                {% if form.weight.errors %}
                                <div class="text-danger small mt-1">{{ form.weight.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="{{ form.length.id_for_label }}" class="form-label">
                                    {{ form.length.label }}
                                </label>
                                <div class="input-group">
                                    {{ form.length }}
                                    <span class="input-group-text">cm</span>
                                </div>
                                {% if form.length.errors %}
                                <div class="text-danger small mt-1">{{ form.length.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="{{ form.width.id_for_label }}" class="form-label">
                                    {{ form.width.label }}
                                </label>
                                <div class="input-group">
                                    {{ form.width }}
                                    <span class="input-group-text">cm</span>
                                </div>
                                {% if form.width.errors %}
                                <div class="text-danger small mt-1">{{ form.width.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="{{ form.height.id_for_label }}" class="form-label">
                                    {{ form.height.label }}
                                </label>
                                <div class="input-group">
                                    {{ form.height }}
                                    <span class="input-group-text">cm</span>
                                </div>
                                {% if form.height.errors %}
                                <div class="text-danger small mt-1">{{ form.height.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Status Settings -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-toggles"></i> {% trans "Durum Ayarları" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                {{ form.is_active }}
                                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                    {{ form.is_active.label }}
                                </label>
                                {% if form.is_active.errors %}
                                <div class="text-danger small mt-1">{{ form.is_active.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">{% trans "Aktif olmayan ürünler listede görünmez" %}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                {{ form.is_featured }}
                                <label class="form-check-label" for="{{ form.is_featured.id_for_label }}">
                                    {{ form.is_featured.label }}
                                </label>
                                {% if form.is_featured.errors %}
                                <div class="text-danger small mt-1">{{ form.is_featured.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">{% trans "Öne çıkan ürünler öncelikli gösterilir" %}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            {% if object %}
                            <a href="{% url 'products:detail' object.slug %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> {% trans "İptal" %}
                            </a>
                            {% else %}
                            <a href="{% url 'products:list' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> {% trans "İptal" %}
                            </a>
                            {% endif %}
                        </div>
                        <div>
                            <button type="submit" name="save_and_continue" class="btn btn-outline-primary me-2">
                                <i class="bi bi-check-circle"></i> {% trans "Kaydet ve Devam Et" %}
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> 
                                {% if object %}
                                    {% trans "Değişiklikleri Kaydet" %}
                                {% else %}
                                    {% trans "Ürün Oluştur" %}
                                {% endif %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Help Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-question-circle"></i> {% trans "Yardım" %}
                </h6>
            </div>
            <div class="card-body">
                <div class="small text-muted">
                    <p><strong>SKU Kodu:</strong> {% trans "Benzersiz stok tutma birimi kodu. Boş bırakılamaz." %}</p>
                    <p><strong>{% trans "Barkod" %}:</strong> {% trans "Ürünün barkod numarası (opsiyonel)." %}</p>
                    <p><strong>{% trans "Min/Max Stok" %}:</strong> {% trans "Otomatik uyarılar için stok seviyeleri." %}</p>
                    <p><strong>{% trans "Fiziksel Özellikler" %}:</strong> {% trans "Depolama ve nakliye için boyut bilgileri." %}</p>
                </div>
            </div>
        </div>
        
        <!-- QR Code Preview (for existing products) -->
        {% if object and object.qr_code %}
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-qr-code"></i> QR Kod
                </h6>
            </div>
            <div class="card-body text-center">
                <img src="{{ object.qr_code.url }}" alt="QR Code" class="img-fluid" style="max-width: 150px;">
                <br>
                <small class="text-muted">{{ object.sku }}</small>
                <div class="mt-2">
                    <small class="text-muted">
                        {% trans "QR kod otomatik olarak oluşturuldu" %}
                    </small>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-generate SKU from product name if empty
document.getElementById('{{ form.name.id_for_label }}').addEventListener('input', function() {
    const nameField = this;
    const skuField = document.getElementById('{{ form.sku.id_for_label }}');
    
    if (!skuField.value && nameField.value) {
        // Generate simple SKU from name
        let sku = nameField.value
            .toUpperCase()
            .replace(/[^A-Z0-9\s]/g, '')
            .replace(/\s+/g, '-')
            .substring(0, 20);
        
        if (sku.length < 3) {
            sku += '-' + Math.random().toString(36).substr(2, 5).toUpperCase();
        }
        
        skuField.value = sku;
    }
});

// Calculate profit margin
function calculateProfitMargin() {
    const costPrice = parseFloat(document.getElementById('{{ form.cost_price.id_for_label }}').value) || 0;
    const sellingPrice = parseFloat(document.getElementById('{{ form.selling_price.id_for_label }}').value) || 0;
    
    if (costPrice > 0 && sellingPrice > 0) {
        const margin = ((sellingPrice - costPrice) / costPrice) * 100;
        console.log('Profit margin: ' + margin.toFixed(1) + '%');
    }
}

document.getElementById('{{ form.cost_price.id_for_label }}').addEventListener('input', calculateProfitMargin);
document.getElementById('{{ form.selling_price.id_for_label }}').addEventListener('input', calculateProfitMargin);

// Validate stock levels
function validateStockLevels() {
    const minStock = parseInt(document.getElementById('{{ form.min_stock_level.id_for_label }}').value) || 0;
    const maxStock = parseInt(document.getElementById('{{ form.max_stock_level.id_for_label }}').value) || 0;
    
    if (minStock >= maxStock && maxStock > 0) {
        alert('{% trans "Minimum stok seviyesi maksimum stok seviyesinden küçük olmalıdır." %}');
    }
}

document.getElementById('{{ form.min_stock_level.id_for_label }}').addEventListener('change', validateStockLevels);
document.getElementById('{{ form.max_stock_level.id_for_label }}').addEventListener('change', validateStockLevels);
</script>
{% endblock %}